import{A as k}from"./main-B_efUyFN.js";const i=(t,e=document)=>e.querySelector(t),x=(t,e=document)=>Array.from(e.querySelectorAll(t)),u=(t,e)=>t?.classList.toggle("hidden",e),n=Object.freeze({content:i("#settingsContent"),tabs:x(".settings-tab"),pages:x("[data-page]"),toast:i("#toast"),spinner:i("#spinner"),subscriptionSelect:i("#subscriptionSelect"),planName:i("#planName"),seatsUsed:i("#seatsUsed"),seatsTotal:i("#seatsTotal"),seatProgress:i("#seatProgress"),seatsBody:i("#seatsBody"),bulkBox:i("#bulkBox"),bulkError:i("#bulkError"),applyBulk:i("#applyBulk"),clearBulk:i("#clearBulk"),btnAddSubscription:i("#btnAddSubscription"),refresh:i("#refresh"),invoiceBody:i("#invoiceBody"),billingView:i("#billingView"),billingEdit:i("#billingEdit"),billingForm:i("#billingForm"),btnBillingEdit:i("#btnBillingEdit"),btnBillingSave:i("#btnBillingSave"),btnBillingCancel:i("#btnBillingCancel"),saveBilling:i("#saveBilling")});function B(t){n.pages.forEach(e=>e.classList.toggle("hidden",e.dataset.page!==t)),n.tabs.forEach(e=>{const a=e.dataset.nav===t;e.classList.toggle("bg-gray-100",a),e.classList.toggle("dark:bg-white/5",a)})}function L(){return location.hash.replace("#","")||"subs"}function _(t){location.hash!==`#${t}`&&(location.hash=t),B(t)}function I(t,e="usd"){return((Number(t)||0)/100).toLocaleString(void 0,{style:"currency",currency:e.toUpperCase()})}function b(t="Saved"){n.toast&&(n.toast.textContent=t,u(n.toast,!1),setTimeout(()=>u(n.toast,!0),1600))}function o(t){u(n.spinner,!t)}function $(t){const e=t.target.closest("button[data-action]");if(!e)return;const a=Number(e.dataset.seat),l=n.seatsBody.querySelector(`[data-seat-input="${a}"]`)?.value.trim(),d=s.currentSubId;(async()=>{try{if(o(!0),e.dataset.action==="assign"){if(!l)return;await N(d,a,l)}else await P(d,a);await y(),p(),f(),b("Updated")}finally{o(!1)}})()}async function C(){const t=await fetch(`${k}/auth/me`,{credentials:"include"});if(t.status===200)return t.json();const e="/manage-subscription.html";throw location.href=`${k}/auth/github/start?returnUrl=${encodeURIComponent(e)}`,new Error("Redirecting to login…")}const c={subs:[{id:"sub_1",label:"Professional (5 seats) — Jul 12 2025",plan:"Professional",totalSeats:5,renewsAt:"2025-07-12",status:"active",currency:"usd"},{id:"sub_2",label:"Professional (10 seats) — Aug 12 2025",plan:"Professional",totalSeats:10,renewsAt:"2025-08-12",status:"trialing",currency:"usd"}],seats:{sub_1:[{seatNo:1,username:"alice",status:"assigned"},{seatNo:2,username:"bob-dev",status:"assigned"},{seatNo:3,username:"",status:"available"},{seatNo:4,username:"",status:"available"},{seatNo:5,username:"",status:"available"}],sub_2:Array.from({length:10},(t,e)=>({seatNo:e+1,username:"",status:"available"}))},invoices:{sub_1:[{id:"inv_2025_0001",date:"2025-07-12",amount:25e4,currency:"usd",status:"paid"},{id:"inv_2025_0002",date:"2025-08-12",amount:25e4,currency:"usd",status:"open"}],sub_2:[{id:"inv_2025_0003",date:"2025-08-12",amount:5e5,currency:"usd",status:"paid"}]},billing:{name:"",vatin:"",line1:"",city:"",postal_code:"",country:""}};async function A(){return c.subs}async function U(t){return c.seats[t]?c.seats[t].map(e=>({...e})):[]}async function F(t){return c.invoices[t]?c.invoices[t].map(e=>({...e})):[]}async function N(t,e,a){const l=(c.seats[t]||[]).find(d=>d.seatNo===e);return l?(l.username=a,l.status=a?"assigned":"available",{ok:!0}):{ok:!1}}async function P(t,e){const r=(c.seats[t]||[]).find(l=>l.seatNo===e);return r?(r.username="",r.status="available",{ok:!0}):{ok:!1}}async function T(t,e){const a=c.seats[t]||[],r=e.slice();for(const l of a){if(!r.length)break;l.username||(l.username=r.shift(),l.status="assigned")}return{ok:!0}}async function M(){return{...c.billing}}async function E(t){return c.billing={...c.billing,...t},{ok:!0}}const s={user:null,subs:[],currentSubId:null,seats:[],invoices:[],billing:null};function H(){const t=n.subscriptionSelect;t.innerHTML="",s.subs.forEach(e=>{const a=document.createElement("option");a.value=e.id,a.textContent=e.label,t.appendChild(a)}),s.currentSubId&&s.subs.some(e=>e.id===s.currentSubId)?t.value=s.currentSubId:s.subs[0]&&(s.currentSubId=s.subs[0].id,t.value=s.currentSubId)}function p(){if(!n.planName||!n.seatsUsed||!n.seatsTotal||!n.seatProgress){console.warn("Summary elements not found; render skipped.");return}const t=s.subs.find(m=>m.id===s.currentSubId),e=s.seats.filter(m=>m.status==="assigned").length,a=t?.totalSeats??0;n.planName.textContent=t?.plan??"-",n.seatsUsed.textContent=String(e),n.seatsTotal.textContent=String(a);const r=i("#renewsAt"),l=i("#subStatus");r&&(r.textContent=t?.renewsAt??"-"),l&&(l.textContent=t?.status??"-");const d=a?Math.round(e/a*100):0;n.seatProgress.style.width=`${d}%`}function f(){n.seatsBody.innerHTML="",s.seats.forEach(({seatNo:t,username:e,status:a})=>{const r=document.createElement("tr");r.innerHTML=`
            <td class="px-4 py-3">#${t}</td>
            <td class="px-4 py-3">
                <input data-seat-input="${t}" value="${e||""}"
                    class="w-full rounded-md border border-gray-300 dark:border-gray-800 bg-transparent px-2 py-1 text-sm"
                    placeholder="github-username" />
            </td>
            <td class="px-4 py-3">
                <span class="inline-flex items-center rounded-full border px-2 py-0.5 text-xs
                    ${a==="assigned"?"border-emerald-300 text-emerald-700 dark:border-emerald-700/40 dark:text-emerald-300":"border-gray-300 text-gray-600 dark:border-white/10 dark:text-gray-300"}">
                    ${a}
                </span>
            </td>
            <td class="px-4 py-3 text-right whitespace-nowrap">
                <button data-action="assign" data-seat="${t}"
                    class="rounded-md border px-2 py-1 text-xs border-gray-300 dark:border-white/20 mr-2">
                    Assign
                </button>
                <button data-action="unassign" data-seat="${t}"
                    class="rounded-md border px-2 py-1 text-xs border-gray-300 dark:border-white/20">
                    Unassign
                </button>
            </td>
        `,n.seatsBody.appendChild(r)})}function v(){n.invoiceBody.innerHTML="";const t=s.subs.find(e=>e.id===s.currentSubId);s.invoices.forEach(e=>{const a=document.createElement("tr");a.innerHTML=`
            <td class="px-4 py-3">${e.id}</td>
            <td class="px-4 py-3">${e.date}</td>
            <td class="px-4 py-3">${I(e.amount,e.currency||t?.currency||"usd")}</td>
            <td class="px-4 py-3 capitalize">${e.status}</td>
            <td class="px-4 py-3 text-right">
                <a class="rounded-md border px-2 py-1 text-xs border-gray-300 dark:border-white/20"
                    href="./invoice.html?id=${encodeURIComponent(e.id)}&sub=${encodeURIComponent(s.currentSubId)}"
                    target="_blank" rel="noopener">
                    View
                </a>
            </td>
        `,n.invoiceBody.appendChild(a)})}function g(t){const e=t==="edit";u(n.billingView,e),u(n.billingEdit,!e),u(n.btnBillingEdit,e),u(n.btnBillingSave,!e),u(n.btnBillingCancel,!e)}function w(t){const e=(a,r)=>{const l=document.getElementById(a);l&&(l.textContent=r||"—")};e("v_name",t?.name),e("v_vatin",t?.vatin),e("v_line1",t?.line1),e("v_city",t?.city),e("v_postal_code",t?.postal_code),e("v_country",t?.country)}function h(t){if(n.billingForm)for(const[e,a]of Object.entries(t||{})){const r=n.billingForm.querySelector(`[name="${e}"]`);r&&(r.value=a??"")}}async function q(){s.subs=await A()}async function y(){s.seats=await U(s.currentSubId)}async function S(){s.invoices=await F(s.currentSubId)}async function R(){const t=await M();s.billing=t,w(t),h(t),g("view")}function V(t){return t.split(/[\s,]+/).map(e=>e.trim()).filter(Boolean).slice(0,999)}function j(){n.tabs.forEach(t=>t.addEventListener("click",()=>_(t.dataset.nav))),window.addEventListener("hashchange",()=>B(L())),n.seatsBody._wired||(n.seatsBody.addEventListener("click",$),n.seatsBody._wired=!0),n.subscriptionSelect.addEventListener("change",async()=>{s.currentSubId=n.subscriptionSelect.value,o(!0);try{await y(),p(),f(),await S(),v()}finally{o(!1)}}),n.applyBulk.addEventListener("click",async()=>{const t=V(n.bulkBox.value);if(t.length!==0){n.bulkError.classList.add("hidden"),o(!0);try{await T(s.currentSubId,t),await y(),p(),f(),b("Bulk assigned")}catch{n.bulkError.classList.remove("hidden")}finally{o(!1)}}}),n.clearBulk.addEventListener("click",()=>{n.bulkBox.value="",n.bulkError.classList.add("hidden")}),n.refresh.addEventListener("click",async()=>{o(!0);try{await Promise.all([y(),S()]),p(),f(),v(),b("Refreshed")}finally{o(!1)}}),n.btnAddSubscription?.addEventListener("click",()=>{location.href="./checkout.html"}),n.btnBillingEdit?.addEventListener("click",()=>{h(s.billing||{}),g("edit")}),n.btnBillingCancel?.addEventListener("click",()=>{h(s.billing||{}),g("view")}),n.btnBillingSave?.addEventListener("click",async()=>{if(!n.billingForm)return;const t=Object.fromEntries(new FormData(n.billingForm).entries());o(!0);try{await E(t),s.billing={...s.billing,...t},w(s.billing),g("view"),b("Billing saved")}finally{o(!1)}}),n.saveBilling?.addEventListener("click",async()=>{if(!n.billingForm)return;const t=Object.fromEntries(new FormData(n.billingForm).entries());o(!0);try{await E(t),s.billing={...s.billing,...t},w(s.billing),g("view"),b("Billing saved")}finally{o(!1)}})}(async function(){try{o(!0),s.user=await C(),j(),await q(),H(),n.btnAddSubscription&&(n.btnAddSubscription.disabled=!1),s.currentSubId&&(await Promise.all([y(),S()]),p(),f(),v()),B(L()),await R()}finally{o(!1)}})();
